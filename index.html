<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penguin Pixel - Secure Crypto Ecosystem</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        /* General Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: linear-gradient(145deg, #1a2338 0%, #2e3f6b 100%);
            margin: 10% auto;
            padding: 20px;
            border-radius: 15px;
            width: 85%;
            max-width: 400px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            color: #ffffff;
            position: relative;
            border: 1px solid #00ff88;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #00ff88;
            font-size: 1.5rem;
            cursor: pointer;
            border: none;
            background: none;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: #00cc6d;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.6rem;
            color: #00ff88;
            text-shadow: 0 0 5px rgba(0, 255, 136, 0.5);
            font-weight: 600;
        }

        /* Wallet Modal Styles */
        .wallet-interface {
            padding: 15px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .wallet-balance {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 204, 109, 0.1));
            border-radius: 10px;
            border: 1px solid #00ff88;
            transition: transform 0.2s ease;
        }

        .wallet-balance:hover {
            transform: scale(1.02);
        }

        .wallet-balance p {
            margin: 0;
            font-size: 1rem;
            opacity: 0.9;
        }

        .wallet-balance span {
            font-size: 1.8rem;
            color: #00ff88;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(0, 255, 136, 0.6);
        }

        .wallet-info {
            margin-bottom: 20px;
        }

        .wallet-info p {
            margin: 8px 0;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            padding: 8px;
            border-radius: 6px;
        }

        .wallet-info i {
            margin-right: 8px;
            color: #00ff88;
            font-size: 1rem;
        }

        .wallet-address-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 255, 136, 0.1);
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #00ff88;
        }

        .wallet-address-container span {
            flex-grow: 1;
            word-break: break-all;
            color: #00ff88;
            font-family: monospace;
            font-size: 0.85rem;
        }

        .copy-btn {
            background: linear-gradient(135deg, #00ff88, #00cc6d);
            color: #1e2a44;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            margin-left: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .copy-btn:hover {
            background: linear-gradient(135deg, #00cc6d, #00ff88);
        }

        .copy-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .wallet-actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 10px;
        }

        .wallet-button {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6d 100%);
            color: #1e2a44;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex: 1;
        }

        .wallet-button:hover {
            transform: scale(1.03);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .wallet-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .wallet-button i {
            margin-right: 6px;
            font-size: 1rem;
        }

        /* Profile Modal Styles */
        .profile-interface {
            padding: 15px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .profile-info p {
            margin: 8px 0;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            padding: 8px;
            border-radius: 6px;
        }

        .profile-info i {
            margin-right: 8px;
            color: #00ff88;
            font-size: 1rem;
        }

        /* Footer Styles */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, #1e2a44 0%, #2a3b66 100%);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .footer-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #ffffff;
            font-size: 0.9rem;
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;
        }

        .footer-item:hover {
            color: #00ff88;
            transform: scale(1.1);
        }

        .footer-item i {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        /* Other Existing Styles */
        .ceo-image {
            text-align: center;
            margin: 20px 0;
        }

        .ceo-image img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .mining-arrow {
            display: none;
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            color: #00ff88;
            font-size: 1.2rem;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0; }
            100% { opacity: 1; }
        }

        .feature {
            position: relative;
        }

        #nn-counter {
            color: #00ff88;
            font-size: 1.5rem;
            padding: 10px;
            text-shadow: 0 0 5px rgba(0, 255, 136, 0.5);
            text-align: center;
        }

        /* Migration Modal Styles */
        .modal-content-enhanced {
            background: linear-gradient(135deg, #1e2a44 0%, #2a3b66 100%);
            margin: 15% auto;
            padding: 20px;
            border-radius: 15px;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            color: #ffffff;
            position: relative;
        }

        .close-enhanced {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #ffffff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .close-enhanced:hover {
            color: #00ff88;
        }

        .highlight-enhanced {
            color: #00ff88;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background-color: #00ff88;
            width: 0%;
            transition: width 0.5s ease-in-out;
        }

        .button-enhanced {
            background-color: #00ff88;
            color: #1e2a44;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            font-size: 1rem;
        }

        .button-enhanced:hover {
            background-color: #00cc6d;
        }

        .button-enhanced:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Tasks Modal Styles */
        .tasks-modal-content {
            background: linear-gradient(135deg, #1e2a44 0%, #2a3b66 100%);
            margin: 15% auto;
            padding: 20px;
            border-radius: 15px;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            color: #ffffff;
            position: relative;
        }

        .tasks-modal-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .tasks-modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: #00ff88;
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(255,255,255,0.1);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .task-item span {
            flex-grow: 1;
            margin-left: 8px;
            font-size: 0.9rem;
        }

        .task-button {
            background-color: #00ff88;
            color: #1e2a44;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.85rem;
        }

        .task-button.completed {
            background-color: #666;
            cursor: not-allowed;
        }

        .task-button:hover:not(.completed) {
            background-color: #00cc6d;
        }
    </style>
</head>
<body>
    <!-- Hamburger Menu -->
    <div id="hamburger-menu">☰</div>
    <div id="dropdown-menu">
        <ul>
            <li id="migration-menu-item">Migration</li>
            <li>Mine</li>
            <li>Wallet</li>
            <li>Setting</li>
        </ul>
    </div>

    <!-- PPXL Counter -->
    <div id="nn-counter">0.0000 PPXL</div>

    <!-- CEO Announcement Section -->
    <div class="ceo-image" id="ceo-announcement-image">
        <img src="https://raw.githubusercontent.com/danvil33/Penguins/refs/heads/main/icon.png" alt="CEO Image">
    </div>

    <!-- Social Buttons -->
    <div class="social-buttons">
        <a href="https://x.com/number_network?t=Y1q9j3rLkzgQnBN9OVZr3A&s=09" class="social-button twitter-button" target="_blank">
            <i class="fab fa-twitter"></i> X/Twitter
        </a>
        <a href="https://t.me/number_network" class="social-button telegram-button" target="_blank">
            <i class="fab fa-telegram-plane"></i> Telegram
        </a>
    </div>

    <!-- Main Container -->
    <div class="container">
        <div class="card">
            <h1></h1>
            <div class="ceo-announcement">
                <div class="ceo-text">
                    <h2>CEO Announcement</h2>
                    <p id="ceo-announcement-text"> hello!
                    🐧 Penguin Pixel – Revolutionizing crypto with speed, security, and innovation! ⚡🔗 Built for the future, it ensures seamless transactions and reliable access to digital assets for everyone. 🚀💎 #CryptoRedefined

 the uniqueness here is you mine and you get automatic migration</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Features Area -->
    <div class="features-area">
        <div class="feature" id="friends-icon">
            <i class="fas fa-user-friends"></i>
            <span id="friends-count">0/0</span>
        </div>
        <div class="feature" id="migration-icon">
            <i class="fas fa-share-alt"></i>
            <span>0.0</span>
        </div>
        <div class="feature" id="wallet-icon">
            <i class="fas fa-wallet"></i>
            <span>Wallet</span>
        </div>
        <div class="feature mining-icon" id="mine-icon">
            <i class="fas fa-hammer"></i>
            <span id="mine-text">Mine</span>
            <span id="mining-rate" style="color: #00ff88; display: none;">0.5/h</span>
            <span class="mining-arrow" id="mining-arrow">⬆️</span>
        </div>
        <div class="feature" id="youtube-icon">
            <i class="fab fa-youtube"></i>
            <span>YouTube</span>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="footer-item" id="home">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </div>
        <div class="footer-item" id="tasks">
            <i class="fas fa-tasks"></i>
            <span>Tasks</span>
        </div>
        <div class="footer-item" id="profile">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </div>
        <div class="footer-item" id="wallet">
            <i class="fas fa-wallet"></i>
            <span>Wallet</span>
        </div>
    </div>

    <!-- Migration Modal -->
    <div id="migrationModal" class="modal">
        <div class="modal-content-enhanced">
            <span class="close-enhanced">×</span>
            <div class="modal-header-enhanced">
                <h2>PPXL Migration</h2>
                <p style="font-size: 0.9rem; opacity: 0.8;">Convert your mined PPXL to tokens</p>
            </div>
            <div class="modal-info-enhanced" style="text-align: center; padding: 15px;">
                <div style="margin-bottom: 10px;">
                    <p style="margin: 5px 0;">Your PPXL Balance:</p>
                    <span class="highlight-enhanced" id="migration-amount" style="font-size: 1.1rem;">0 PPXL</span>
                </div>
                <div style="margin-bottom: 10px;">
                    <p style="margin: 5px 0;">Migration Fee:</p>
                    <span class="highlight-enhanced" id="migration-fee">3 USDT</span>
                    <span id="ton-equivalent" style="display: block; font-size: 0.8rem; opacity: 0.7;">(Calculating TON...)</span>
                </div>
                <div>
                    <p style="margin: 5px 0;">Attempts Left:</p>
                    <span class="highlight-enhanced" id="migrationAttempts">2</span>
                </div>
            </div>
            <div class="modal-buttons-enhanced" style="text-align: center;">
                <button class="button-enhanced migrate-coins-enhanced" id="startMigrationBtn">
                    Start Migration
                </button>
            </div>
            <div class="modal-status-enhanced" id="migrationStatus" style="text-align: center; margin-top: 10px; min-height: 20px; font-size: 0.9rem;"></div>
            <div class="queue-status" id="queueStatus" style="display: none; text-align: center; margin-top: 15px;">
                <p>Queue Position: <span id="queuePosition">0</span></p>
                <div class="progress-bar">
                    <div class="progress" id="queueProgress"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wallet Modal -->
    <div id="walletModal" class="modal">
        <div class="modal-content">
            <button class="modal-close">×</button>
            <div class="modal-header">
                <h2><i class="fas fa-wallet"></i> Penguin Wallet</h2>
            </div>
            <div class="wallet-interface">
                <div class="wallet-balance">
                    <p>Your PPXL Balance</p>
                    <span id="walletPPXLBalance">0.0000 PPXL</span>
                </div>
                <div class="wallet-info">
                    <p><i class="fas fa-link"></i> Status: <span id="connectionStatus">Not Connected</span></p>
                    <p><i class="fas fa-address-card"></i> TON Address: <span id="walletAddress">None</span></p>
                    <p class="wallet-address-container">
                        <i class="fas fa-paw"></i> Penguin Address: 
                        <span id="penguinAddress">Not Generated</span>
                        <button class="copy-btn" id="copyPenguinAddress" disabled><i class="fas fa-copy"></i></button>
                    </p>
                </div>
                <div class="wallet-actions">
                    <button class="wallet-button connect-button" id="connectWalletBtn">
                        <i class="fas fa-plug"></i> Connect
                    </button>
                    <button class="wallet-button disconnect-button" id="disconnectWalletBtn" style="display: none;">
                        <i class="fas fa-sign-out-alt"></i> Disconnect
                    </button>
                    <button class="wallet-button send-button" id="sendPPXLBtn">
                        <i class="fas fa-paper-plane"></i> Send PPXL
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <button class="modal-close">×</button>
            <div class="modal-header">
                <h2><i class="fas fa-user"></i> User Profile</h2>
            </div>
            <div class="profile-interface">
                <div class="profile-info">
                    <p><i class="fas fa-paw"></i> Penguin Address: <span id="profilePenguinAddress">Not Connected</span></p>
                    <p><i class="fas fa-address-card"></i> TON Address: <span id="profileTonAddress">None</span></p>
                    <p><i class="fas fa-coins"></i> Balance: <span id="profileBalance">0.0000 PPXL</span></p>
                    <p><i class="fas fa-hammer"></i> Mining: <span id="profileMiningStatus">Inactive</span></p>
                    <p><i class="fas fa-tasks"></i> Tasks: <span id="profileTasksCompleted">0/3</span></p>
                    <p><i class="fas fa-user-plus"></i> Invite Link: <span id="inviteLink">Connect wallet to generate</span> 
                        <button class="copy-btn" id="copyInviteLink" disabled><i class="fas fa-copy"></i></button></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tasks Modal -->
    <div id="tasksModal" class="modal">
        <div class="tasks-modal-content">
            <button class="modal-close">×</button>
            <div class="tasks-modal-header">
                <h2>Tasks</h2>
            </div>
            <div class="tasks-list">
                <div class="task-item">
                    <i class="fab fa-youtube"></i>
                    <span>Follow us on YouTube</span>
                    <button class="task-button" id="youtubeTaskBtn">Follow (5 PPXL)</button>
                </div>
                <div class="task-item">
                    <i class="fab fa-twitter"></i>
                    <span>Follow us on X</span>
                    <button class="task-button" id="xTaskBtn">Follow (5 PPXL)</button>
                </div>
                <div class="task-item">
                    <i class="fab fa-telegram-plane"></i>
                    <span>Join us on Telegram</span>
                    <button class="task-button" id="telegramTaskBtn">Join (5 PPXL)</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize TON Connect
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://danvil33.github.io/Penguins/tonconnect-manifest.json',
        });

        // DOM Elements
        const walletIcon = document.getElementById('wallet-icon');
        const migrationIcon = document.getElementById('migration-icon');
        const migrationModal = document.getElementById('migrationModal');
        const startMigrationBtn = document.getElementById('startMigrationBtn');
        const migrationStatus = document.getElementById('migrationStatus');
        const nnCounterDisplay = document.getElementById('nn-counter');
        const mineIcon = document.getElementById('mine-icon');
        const mineText = document.getElementById('mine-text');
        const miningRate = document.getElementById('mining-rate');
        const miningArrow = document.getElementById('mining-arrow');
        const youtubeIcon = document.getElementById('youtube-icon');
        const walletModal = document.getElementById('walletModal');
        const walletClose = walletModal.querySelector('.modal-close');
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const disconnectWalletBtn = document.getElementById('disconnectWalletBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const walletAddress = document.getElementById('walletAddress');
        const penguinAddress = document.getElementById('penguinAddress');
        const copyPenguinAddressBtn = document.getElementById('copyPenguinAddress');
        const homeFooter = document.getElementById('home');
        const tasksFooter = document.getElementById('tasks');
        const profileFooter = document.getElementById('profile');
        const walletFooter = document.getElementById('wallet');
        const profileModal = document.getElementById('profileModal');
        const profileClose = profileModal.querySelector('.modal-close');
        const tasksModal = document.getElementById('tasksModal');
        const tasksClose = tasksModal.querySelector('.modal-close');
        const youtubeTaskBtn = document.getElementById('youtubeTaskBtn');
        const xTaskBtn = document.getElementById('xTaskBtn');
        const telegramTaskBtn = document.getElementById('telegramTaskBtn');
        const tonEquivalent = document.getElementById('ton-equivalent');
        const friendsCount = document.getElementById('friends-count');
        const inviteLink = document.getElementById('inviteLink');
        const copyInviteLinkBtn = document.getElementById('copyInviteLink');

        // State Variables
        let nnCounter = parseFloat(localStorage.getItem('nnCounter')) || 0;
        let startTime = parseFloat(localStorage.getItem('startTime')) || null;
        let lastMigratedBalance = parseFloat(localStorage.getItem('lastMigratedBalance')) || 0;
        let miningInterval = null;
        let miningEndTime = null;
        let migrationAttempts = parseInt(localStorage.getItem('migrationAttempts')) || 2;
        let inQueue = false;
        let queuePosition = 0;
        let tasksCompleted = JSON.parse(localStorage.getItem('tasksCompleted')) || {
            youtube: false,
            x: false,
            telegram: false
        };
        let userPenguinAddress = localStorage.getItem('penguinAddress') || null;
        let userDatabase = JSON.parse(localStorage.getItem('userDatabase')) || {};
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let baseRate = 0.5; // Base mining rate (PPXL/hour)
        let referralBonus = 0; // Additional rate from referrals
        let referrals = JSON.parse(localStorage.getItem('referrals')) || []; // Array of referred Penguin Addresses
        let activeMiners = 0;

        // Mining Rate (converted to per second)
        function getMiningRate() {
            return (baseRate + referralBonus) / 3600;
        }

        // Generate Penguin Pixel Address
        function generatePenguinAddress(tonAddress) {
            if (!userPenguinAddress && tonAddress) {
                const randomString = Math.random().toString(36).substring(2, 8).toUpperCase();
                const tonSnippet = tonAddress.slice(-6);
                userPenguinAddress = `PPXL-${randomString}-${tonSnippet}`;
                localStorage.setItem('penguinAddress', userPenguinAddress);
                if (!userDatabase[userPenguinAddress]) {
                    userDatabase[userPenguinAddress] = { tonAddress, balance: 0, mining: false };
                }
                localStorage.setItem('userDatabase', JSON.stringify(userDatabase));
            }
            return userPenguinAddress;
        }

        // Update Counter and Sync with Database
        function updateCounter() {
            if (startTime) {
                const currentTime = Date.now();
                const elapsedTime = (currentTime - startTime) / 1000;
                nnCounter += elapsedTime * getMiningRate();
                localStorage.setItem('nnCounter', nnCounter.toFixed(4));
                startTime = currentTime;
                localStorage.setItem('startTime', startTime);
            }
            nnCounterDisplay.textContent = nnCounter.toFixed(4) + ' PPXL';
            document.getElementById('walletPPXLBalance').textContent = nnCounter.toFixed(4) + ' PPXL';
            if (tonConnectUI.wallet && userPenguinAddress) {
                userDatabase[userPenguinAddress].balance = nnCounter;
                userDatabase[userPenguinAddress].mining = !!startTime;
                localStorage.setItem('userDatabase', JSON.stringify(userDatabase));
            }
            miningRate.textContent = `${(baseRate + referralBonus).toFixed(1)}/h`;
        }

        // Sync Local Balance with Database
        function syncBalanceWithDatabase() {
            if (tonConnectUI.wallet && userPenguinAddress && userDatabase[userPenguinAddress]) {
                nnCounter = userDatabase[userPenguinAddress].balance;
                localStorage.setItem('nnCounter', nnCounter.toFixed(4));
                updateCounter();
            }
        }

        // Start Mining
        function startMining() {
            if (!startTime) {
                startTime = Date.now();
                miningEndTime = startTime + 12 * 60 * 60 * 1000;
                localStorage.setItem('startTime', startTime);
                localStorage.setItem('miningEndTime', miningEndTime);
                mineText.style.display = 'none';
                miningRate.style.display = 'inline';
                miningArrow.style.display = 'none';
                if (miningInterval) clearInterval(miningInterval);
                miningInterval = setInterval(updateCounter, 1000);
            }
        }

        // Stop Mining
        function stopMining() {
            if (miningEndTime && Date.now() >= miningEndTime) {
                clearInterval(miningInterval);
                startTime = null;
                miningEndTime = null;
                localStorage.removeItem('startTime');
                localStorage.removeItem('miningEndTime');
                mineText.style.display = 'inline';
                miningRate.style.display = 'none';
                miningArrow.style.display = 'block';
                updateCounter();
                miningInterval = null;
            }
        }

        // Fetch TON Price
        async function getTonPriceInUSD() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=usd');
                const data = await response.json();
                return data['the-open-network'].usd;
            } catch (error) {
                console.error('Error fetching TON price:', error);
                return 5; // Fallback
            }
        }

        // Calculate TON Amount for 3 USDT
        async function calculateTonAmount() {
            const tonPrice = await getTonPriceInUSD();
            const usdtAmount = 3;
            const tonAmount = usdtAmount / tonPrice;
            const tonAmountNano = Math.floor(tonAmount * 1e9);
            tonEquivalent.textContent = `(~${tonAmount.toFixed(4)} TON)`;
            return tonAmountNano;
        }

        // Update Migration Modal
        async function updateMigrationModal() {
            document.getElementById('migration-amount').textContent = `${nnCounter.toFixed(4)} PPXL`;
            document.getElementById('migrationAttempts').textContent = migrationAttempts;
            await calculateTonAmount();
        }

        // Migration Functions
        async function initiateMigration() {
            const migrationStatus = document.getElementById('migrationStatus');
            const startMigrationBtn = document.getElementById('startMigrationBtn');
            const migrationAttemptsDisplay = document.getElementById('migrationAttempts');

            if (migrationAttempts <= 0) {
                migrationStatus.textContent = 'No attempts remaining!';
                startMigrationBtn.disabled = true;
                return;
            }

            if (!tonConnectUI.wallet) {
                migrationStatus.textContent = 'Please connect wallet to migrate!';
                return;
            }

            migrationStatus.textContent = 'Preparing payment...';
            startMigrationBtn.disabled = true;

            try {
                const tonAmountNano = await calculateTonAmount();
                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 60,
                    messages: [{ address: 'UQABi--VPQ0JPUjVMXXYWEAxWsFpRfJGL-EKi7zH3UFdFsyz', amount: tonAmountNano.toString() }]
                };
                const result = await tonConnectUI.sendTransaction(transaction);
                if (result) {
                    migrationStatus.textContent = 'Payment successful! Processing...';
                    await addToMigrationQueue();
                    migrationAttempts--;
                    localStorage.setItem('migrationAttempts', migrationAttempts);
                    migrationAttemptsDisplay.textContent = migrationAttempts;
                    if (migrationAttempts === 1) migrationStatus.textContent = 'Test migration completed!';
                    else if (migrationAttempts === 0) {
                        migrationStatus.textContent = 'Final migration completed!';
                        startMigrationBtn.textContent = 'Migration Complete';
                    }
                }
            } catch (error) {
                migrationStatus.textContent = 'Error: ' + error.message;
                startMigrationBtn.disabled = false;
            }
        }

        async function addToMigrationQueue() {
            const queueStatus = document.getElementById('queueStatus');
            const queuePositionDisplay = document.getElementById('queuePosition');
            const queueProgress = document.getElementById('queueProgress');

            inQueue = true;
            queuePosition = Math.floor(Math.random() * 5) + 1;
            queueStatus.style.display = 'block';
            queuePositionDisplay.textContent = queuePosition;
            queueProgress.style.width = `${(5 - queuePosition) * 20}%`;

            const queueInterval = setInterval(() => {
                if (queuePosition > 0) {
                    queuePosition--;
                    queuePositionDisplay.textContent = queuePosition;
                    queueProgress.style.width = `${(5 - queuePosition) * 20}%`;
                } else {
                    clearInterval(queueInterval);
                    completeMigration();
                }
            }, 2000);
        }

        function completeMigration() {
            const queueStatus = document.getElementById('queueStatus');
            const migrationStatus = document.getElementById('migrationStatus');
            const migrationAmount = document.getElementById('migration-amount');
            const startMigrationBtn = document.getElementById('startMigrationBtn');

            const amountToMigrate = nnCounter - lastMigratedBalance;
            if (amountToMigrate > 0) {
                nnCounter += 100;
                lastMigratedBalance = nnCounter;
                localStorage.setItem('nnCounter', nnCounter.toFixed(4));
                localStorage.setItem('lastMigratedBalance', lastMigratedBalance.toFixed(4));
                if (userPenguinAddress) {
                    userDatabase[userPenguinAddress].balance = nnCounter;
                    localStorage.setItem('userDatabase', JSON.stringify(userDatabase));
                }
                updateCounter();
                migrationAmount.textContent = `${nnCounter.toFixed(4)} PPXL`;
                migrationStatus.textContent = `Migrated ${amountToMigrate.toFixed(4)} PPXL + 100 PPXL bonus!`;
            }
            queueStatus.style.display = 'none';
            inQueue = false;
            startMigrationBtn.disabled = false;
        }

        // Update Wallet Modal
        function updateWalletModal() {
            if (tonConnectUI.wallet) {
                connectionStatus.textContent = 'Connected';
                walletAddress.textContent = tonConnectUI.wallet.account.address.slice(0, 6) + '...' + tonConnectUI.wallet.account.address.slice(-4);
                connectWalletBtn.style.display = 'none';
                disconnectWalletBtn.style.display = 'block';
                penguinAddress.textContent = generatePenguinAddress(tonConnectUI.wallet.account.address) || 'Not Generated';
                copyPenguinAddressBtn.disabled = false;
                syncBalanceWithDatabase();
            } else {
                connectionStatus.textContent = 'Not Connected';
                walletAddress.textContent = 'None';
                penguinAddress.textContent = 'Not Generated';
                connectWalletBtn.style.display = 'block';
                disconnectWalletBtn.style.display = 'none';
                copyPenguinAddressBtn.disabled = true;
                userPenguinAddress = null;
                localStorage.removeItem('penguinAddress');
            }
            document.getElementById('walletPPXLBalance').textContent = nnCounter.toFixed(4) + ' PPXL';
        }

        // Update Profile Modal
        function updateProfileModal() {
            document.getElementById('profilePenguinAddress').textContent = userPenguinAddress || 'Not Connected';
            document.getElementById('profileTonAddress').textContent = tonConnectUI.wallet ? tonConnectUI.wallet.account.address.slice(0, 6) + '...' + tonConnectUI.wallet.account.address.slice(-4) : 'None';
            document.getElementById('profileBalance').textContent = nnCounter.toFixed(4) + ' PPXL';
            document.getElementById('profileMiningStatus').textContent = startTime ? 'Active' : 'Inactive';
            const tasksDone = Object.values(tasksCompleted).filter(Boolean).length;
            document.getElementById('profileTasksCompleted').textContent = `${tasksDone}/3`;
            if (userPenguinAddress) {
                const inviteUrl = `http://t.me/Penguin_pixelbot?start=ref_${userPenguinAddress}`;
                inviteLink.textContent = inviteUrl;
                copyInviteLinkBtn.disabled = false;
            } else {
                inviteLink.textContent = 'Connect wallet to generate';
                copyInviteLinkBtn.disabled = true;
            }
        }

        // Update Friends Count
        function updateFriendsCount() {
            activeMiners = Object.values(userDatabase).filter(user => user.mining && referrals.includes(user.penguinAddress)).length;
            const totalFriends = referrals.length;
            friendsCount.textContent = `${activeMiners}/${totalFriends}`;
        }

        // Handle Referral
        function handleReferral(referrerId) {
            if (!userPenguinAddress || userPenguinAddress === referrerId || referrals.includes(userPenguinAddress)) return;
            if (userDatabase[referrerId]) {
                referrals.push(userPenguinAddress);
                localStorage.setItem('referrals', JSON.stringify(referrals));
                referralBonus += 0.5;
                localStorage.setItem('referralBonus', referralBonus);
                updateCounter();
                updateFriendsCount();
            }
        }

        // Update Task Buttons
        function updateTaskButtons() {
            if (tasksCompleted.youtube) {
                youtubeTaskBtn.textContent = 'Completed';
                youtubeTaskBtn.classList.add('completed');
                youtubeTaskBtn.disabled = true;
            }
            if (tasksCompleted.x) {
                xTaskBtn.textContent = 'Completed';
                xTaskBtn.classList.add('completed');
                xTaskBtn.disabled = true;
            }
            if (tasksCompleted.telegram) {
                telegramTaskBtn.textContent = 'Completed';
                telegramTaskBtn.classList.add('completed');
                telegramTaskBtn.disabled = true;
            }
        }

        // Reward User
        function rewardUser(task) {
            if (!tasksCompleted[task]) {
                nnCounter += 5;
                tasksCompleted[task] = true;
                localStorage.setItem('nnCounter', nnCounter.toFixed(4));
                localStorage.setItem('tasksCompleted', JSON.stringify(tasksCompleted));
                if (userPenguinAddress) {
                    userDatabase[userPenguinAddress].balance = nnCounter;
                    localStorage.setItem('userDatabase', JSON.stringify(userDatabase));
                }
                updateCounter();
                updateTaskButtons();
                updateProfileModal();
            }
        }

        // Event Listeners
        walletIcon.addEventListener('click', async () => {
            if (!tonConnectUI.wallet) {
                try {
                    await tonConnectUI.connectWallet();
                    updateWalletModal();
                    updateProfileModal();
                    updateFriendsCount();
                } catch (error) {
                    console.error('Wallet connection failed:', error);
                }
            }
        });

        mineIcon.addEventListener('click', startMining);

        youtubeIcon.addEventListener('click', () => {
            window.open('https://www.youtube.com/@penguin_pixel', '_blank');
        });

        migrationIcon.addEventListener('click', async () => {
            migrationModal.style.display = 'block';
            await updateMigrationModal();
        });

        startMigrationBtn.addEventListener('click', initiateMigration);

        migrationModal.querySelector('.close-enhanced').addEventListener('click', () => {
            if (!inQueue) migrationModal.style.display = 'none';
        });

        walletClose.addEventListener('click', () => {
            walletModal.style.display = 'none';
        });

        connectWalletBtn.addEventListener('click', async () => {
            try {
                await tonConnectUI.connectWallet();
                updateWalletModal();
                updateProfileModal();
                updateFriendsCount();
            } catch (error) {
                console.error('Wallet connection failed:', error);
                connectionStatus.textContent = 'Connection Failed';
            }
        });

        disconnectWalletBtn.addEventListener('click', async () => {
            try {
                await tonConnectUI.disconnect();
                updateWalletModal();
                updateProfileModal();
                updateFriendsCount();
            } catch (error) {
                console.error('Wallet disconnection failed:', error);
                connectionStatus.textContent = 'Disconnection Failed';
            }
        });

        copyPenguinAddressBtn.addEventListener('click', () => {
            if (!tonConnectUI.wallet) {
                alert('Connect wallet to copy your Penguin Address!');
                return;
            }
            navigator.clipboard.writeText(penguinAddress.textContent);
            alert('Penguin Pixel Address copied to clipboard!');
        });

        copyInviteLinkBtn.addEventListener('click', () => {
            if (!tonConnectUI.wallet) {
                alert('Connect wallet to copy your invite link!');
                return;
            }
            navigator.clipboard.writeText(inviteLink.textContent);
            alert('Invite link copied to clipboard!');
        });

        document.getElementById('sendPPXLBtn').addEventListener('click', () => {
            const recipientInput = prompt('Enter recipient Penguin Pixel Address:');
            const amount = parseFloat(prompt('Enter PPXL amount to send:'));

            if (!recipientInput || !amount || amount <= 0 || amount > nnCounter) {
                alert('Invalid input or insufficient balance!');
                return;
            }

            if (!recipientInput.startsWith('PPXL-')) {
                alert('Please enter a valid Penguin Pixel Address (starts with PPXL-)');
                return;
            }

            const recipientData = userDatabase[recipientInput] || { tonAddress: null, balance: 0, mining: false };
            if (!userDatabase[recipientInput]) {
                userDatabase[recipientInput] = recipientData;
            }

            nnCounter -= amount;
            localStorage.setItem('nnCounter', nnCounter.toFixed(4));
            userDatabase[recipientInput].balance += amount;

            if (tonConnectUI.wallet && userPenguinAddress) {
                userDatabase[userPenguinAddress].balance = nnCounter;
                const transaction = {
                    from: userPenguinAddress,
                    to: recipientInput,
                    amount: amount,
                    timestamp: Date.now()
                };
                transactions.unshift(transaction);
                localStorage.setItem('transactions', JSON.stringify(transactions));
            }

            localStorage.setItem('userDatabase', JSON.stringify(userDatabase));
            updateCounter();
            updateProfileModal();
            updateWalletModal();
            alert(`Sent ${amount.toFixed(4)} PPXL to ${recipientInput}. They need to connect their wallet to see it!`);
        });

        homeFooter.addEventListener('click', () => {
            migrationModal.style.display = 'none';
            walletModal.style.display = 'none';
            tasksModal.style.display = 'none';
            profileModal.style.display = 'none';
            window.scrollTo(0, 0);
        });

        tasksFooter.addEventListener('click', () => {
            tasksModal.style.display = 'block';
            updateTaskButtons();
        });

        profileFooter.addEventListener('click', () => {
            profileModal.style.display = 'block';
            updateProfileModal();
            updateFriendsCount();
        });

        walletFooter.addEventListener('click', () => {
            walletModal.style.display = 'block';
            updateWalletModal();
        });

        profileClose.addEventListener('click', () => {
            profileModal.style.display = 'none';
        });

        tasksClose.addEventListener('click', () => {
            tasksModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target === walletModal) walletModal.style.display = 'none';
            if (event.target === tasksModal) tasksModal.style.display = 'none';
            if (event.target === profileModal) profileModal.style.display = 'none';
        });

        youtubeTaskBtn.addEventListener('click', () => {
            if (!tasksCompleted.youtube) {
                window.open('https://www.youtube.com/@penguin_pixel', '_blank');
                setTimeout(() => rewardUser('youtube'), 2000);
            }
        });

        xTaskBtn.addEventListener('click', () => {
            if (!tasksCompleted.x) {
                window.open('https://x.com/number_network', '_blank');
                setTimeout(() => rewardUser('x'), 2000);
            }
        });

        telegramTaskBtn.addEventListener('click', () => {
            if (!tasksCompleted.telegram) {
                window.open('https://t.me/number_network', '_blank');
                setTimeout(() => rewardUser('telegram'), 2000);
            }
        });

        // Simulate Referral from URL (for demo purposes)
        const urlParams = new URLSearchParams(window.location.search);
        const ref = urlParams.get('ref');
        if (ref && ref.startsWith('PPXL-')) {
            handleReferral(ref);
        }

        // Initialize
        if (!startTime) {
            miningArrow.style.display = 'block';
        } else {
            mineText.style.display = 'none';
            miningRate.style.display = 'inline';
        }

        window.addEventListener('load', async () => {
            referralBonus = parseFloat(localStorage.getItem('referralBonus')) || 0;
            await calculateTonAmount();
            updateCounter();
            setInterval(stopMining, 1000);
            if (startTime) miningInterval = setInterval(updateCounter, 1000);
            updateWalletModal();
            updateProfileModal();
            updateFriendsCount();
        });
    </script>
</body>
</html>
